use std::collections::HashMap;

type Cache = HashMap<(usize, Vec<usize>), u128>;
type Grid = Vec<Vec<char>>;

pub fn main() {
    let real_input = "
    ......................................................................S......................................................................
.............................................................................................................................................
......................................................................^......................................................................
.............................................................................................................................................
.....................................................................^.^.....................................................................
.............................................................................................................................................
....................................................................^.^.^....................................................................
.............................................................................................................................................
...................................................................^...^.^...................................................................
.............................................................................................................................................
..................................................................^.......^..................................................................
.............................................................................................................................................
.................................................................^.^.^...^.^.................................................................
.............................................................................................................................................
................................................................^.^.^.^.^...^................................................................
.............................................................................................................................................
...............................................................^.^.....^.....^...............................................................
.............................................................................................................................................
..............................................................^.^.^...^...^.^.^..............................................................
.............................................................................................................................................
.............................................................^.^.^.^.^.....^...^.............................................................
.............................................................................................................................................
............................................................^.^.^.....^.^.^.^.^.^............................................................
.............................................................................................................................................
...........................................................^...^.^.^...^.^...^.^.^...........................................................
.............................................................................................................................................
..........................................................^.^...^.....^.^.^.^.....^..........................................................
.............................................................................................................................................
.........................................................^...^...^...^.^.^.^.^...^.^.........................................................
.............................................................................................................................................
........................................................^.^...^.^.^.^.^.^.^.^.^...^.^........................................................
.............................................................................................................................................
.......................................................^.^...^.^.....^.^.^.^.^.^.^.^.^.......................................................
.............................................................................................................................................
......................................................^.^.^.......^.^.^.^.....^...^.^.^......................................................
.............................................................................................................................................
.....................................................^.^...^.....^.^.^...^.^...^.^.^...^.....................................................
.............................................................................................................................................
....................................................^.^.^.^.^.^.^.^...^.......^.^...^.^.^....................................................
.............................................................................................................................................
...................................................^...^.^.^.^...^.....^.^...^.^.^.^.^.^.^...................................................
.............................................................................................................................................
..................................................^.....^.^...^...^...^.^...^.....^.^.^...^..................................................
.............................................................................................................................................
.................................................^.^.^...^.^...^...^...^.^...^.^.^.^.^.^.^.^.................................................
.............................................................................................................................................
................................................^.^.^.^.^.....^.^...^.^.^.....^.^.^.^.....^.^................................................
.............................................................................................................................................
...............................................^.^.^.^.^.^.^.^.^.^...^.^.^.^.^...^...^...^.^.^...............................................
.............................................................................................................................................
..............................................^...^.^.^...^.....^.^.^.^...^.^...^.^...^.^.^.^.^..............................................
.............................................................................................................................................
.............................................^.....^.^.^.^.^.^...^...^.........^...^...^.^.....^.............................................
.............................................................................................................................................
............................................^.^.^.^.^.^.^.^.^...^.^...^...^.^...^.^.^.^.^...^.^.^............................................
.............................................................................................................................................
...........................................^...^.^.^.^.^.^...^.^...^.^.^.....^.....^.^...^.^.^...^...........................................
.............................................................................................................................................
..........................................^.^.^.^.^.^.^...^.^...^.....^...^.^.....^.....^.^.....^.^..........................................
.............................................................................................................................................
.........................................^.^.^.^.^.^...^.^.^...^.^.^.^.^.^.^.^.^.....^.^.^...^.....^.........................................
.............................................................................................................................................
........................................^...^.^.^.....^.^.^.^...^.^...^.^.^...^...^...^.^.......^.^.^........................................
.............................................................................................................................................
.......................................^...^.....^.^.....^.^...^.^...^...^...^.....^...^.^.......^.^.^.......................................
.............................................................................................................................................
......................................^.^.........^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^...^.^...^......................................
.............................................................................................................................................
.....................................^.^.^.^.^.....^.^.^.^.....^.^.^.^.....^.^.^.^.....^.^...^.^.^.^...^.....................................
.............................................................................................................................................
....................................^.^...^.^.^.....^...^...^.^.^.^.^.^...^.^...^.^.^.^.^...^.......^...^....................................
.............................................................................................................................................
...................................^.^...^.^.^.^.^...^.^.^.....^.^.^.^.....^.^.^.....^...^...^...........^...................................
.............................................................................................................................................
..................................^.^.^.^...^.^.^...^.^.^.^.^.^.....^.^.^.^.....^.^.^.^.^.^...^.^...^...^.^..................................
.............................................................................................................................................
.................................^...^.^...^.^.^.....^.^...^.^...^...^...^.^.^...^.^...^.^...^...^.^.^.^...^.................................
.............................................................................................................................................
................................^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.....^.......^.^.^.......^.^...^.^.^.^...^................................
.............................................................................................................................................
...............................^.^...^.^.^.^.^...^...^.........^.^.^.^...^...^.^.^.^...^.....^.^.^.^.^.^.^...^...............................
.............................................................................................................................................
..............................^...^.........^.^.^.^.^...^.^.^.^.......^.^.^.^.....^.^.^.^.^...^.^.^.^.^.^.^...^..............................
.............................................................................................................................................
.............................^.^.^...^.....^...^.^.^.....^.....^.^.^.^.^.....^.^.^...^.....^.^.^.......^.^.^.^.^.............................
.............................................................................................................................................
............................^...^.....^...^.^...^.^.^...^.....^.......^.^.....^.^...^...^.^.^.^.^...^.^.^.......^............................
.............................................................................................................................................
...........................^.^.^...^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^...^.^.^...^...^.^.^.^.^...^.^.^...^...........................
.............................................................................................................................................
..........................^.....^.^.^.....^.^.^.....^.......^.^.^.^.^.^.^.^.^.^.^...^.....^.....^.^.^.^.^.^...^.^.^..........................
.............................................................................................................................................
.........................^...^.^...^...^.^...^.^.^.^.^.^.........^.^.^.....^.^.^.^.......^.^.^.........^.^.......^.^.........................
.............................................................................................................................................
........................^...^.^.^...^.^.^.^...^.^.....^...^.^.^...^.......^.^.^...^.^.^.^.^.^.^.^.^.^...^.....^.^.^.^........................
.............................................................................................................................................
.......................^...^.^.^.^...^...^.^...^.^.^.^.^.^.^...^.......^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^...^.......................
.............................................................................................................................................
......................^.^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.....^.^.^...^...^...^.^...^.^.^...^...^......................
.............................................................................................................................................
.....................^.^.^.^.^.^.^.^...^.^.^.^.....^.^.^.^.^.........^.^.....^.^...^.....^.^.....^.^.^.^.......^.^...^.^.....................
.............................................................................................................................................
....................^.^.^.^.^.^.^...^.....^.^.^.^...^...^.^.^...^.^.^.^...^.^...^.^.^.^.^...^.^.^.^.^...^.^...^.^.^.^.^.^....................
.............................................................................................................................................
...................^.^...^.^...........^.^.^.^.....^.^.^...^.....^.^.^.....^.^.^.^...^.^.^.^.^...^.^.^.^.^.....^...^.....^...................
.............................................................................................................................................
..................^.^.^...^.^.^.^.^.^.^...^.^...^.^.^.^.^.^.^...^...^...^.^.^.^.^...........^.^.^...^.....^...^.....^.^.^.^..................
.............................................................................................................................................
.................^.^.^.^.^.^.....^.^...^.^.^.^.^...^...^.^.^.^.^.....^.....^.^.^...^.^.^.^.^.^...^.^.......^.^.^.^...^.^...^.................
.............................................................................................................................................
................^.^.^.^.^...^.^...^.^.....^.^.^.^.^.^...^.....^.^.....^.^.^.^.^.^.^...^.^...^...^.^.....^.^...^.^.^.^.^.^.^.^................
.............................................................................................................................................
...............^.^.^.^.^.^.^.....^.^...^.^.^.^.....^.^.....^.^.^.^.^.^.....^.^.^.^...^...^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^...............
.............................................................................................................................................
..............^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.........^.^.^.^.^.^.^.^...^.^.....^.^.^...^...^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^..............
.............................................................................................................................................
.............^.^.....^.^.^.^...^.^.^.^.^...^...^...^.^.^.^...^...^.....^...^.^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.............
.............................................................................................................................................
............^...^.^.^.^...^.^.^.^.^.^...^.^.^...^.^.^.....^...^.....^.^.^.^...^...^...^.^.^.^...^...^.^.^.^.^.....^.^.....^.^.^.^............
.............................................................................................................................................
...........^...^.^.^.^.^...^.^...^.....^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.....^.^.^.^...........
.............................................................................................................................................
..........^.....^.^.^.^.^...^.^.^.^.^...^...^.^...^...^.^...^...^.....^.^.^.^.^.^.^...^...^.^.^.^...^.^.^.^.....^.^.^.^.^.^.^.^...^..........
.............................................................................................................................................
.........^.^.^...^.^.^.^...^.......^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.^.^...^.^.....^.^.^.^.^.....^...^...^.^.^.......^...^.....^.........
.............................................................................................................................................
........^.^.^.^.^.^.^...^.^.^.....^.^...^.^.............^.^.^.^.^...^...^.^.^...^.^...^...^.^...^.^.^.^.....^.^.^.^.^.^.^.^.^...^.^.^........
.............................................................................................................................................
.......^.^.^.^.^.^.^.^...^...^.^.^.^.^...^.^.^.........^.^...^.^.^.^.^.^.^.^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.^...^...^...^.....^.^.^.^.......
.............................................................................................................................................
......^.^.^.^...^.^.^.......^.^.^.^.^.^.^.^.^...^...^.^.^.^.^...^.^.^...^...^.^.^...^...^.^.....^.^.....^...^.^.^.^.^.^.^...^...^.^.^.^......
.............................................................................................................................................
.....^...^...^.^...^.....^.^.......^...^.^...^.^.^.^...^...^.^...^...^...^.^...^.^.^.^.......^.^.^.....^.....^.^...^.^.......^.^.......^.....
.............................................................................................................................................
....^.^.^.......^...^.^.^.^.^.^.......^.^.^.^.^.^.^.^.^.^...^.^.......^.^...^.^...^.......^.^.^.^.^.....^.^.^.....^.^.^.^.^.....^...^...^....
.............................................................................................................................................
...^.........^...^.^.^...^...^.^...^.^.^.^.^.^.....^.^.^.....^.^.^.......^.....^.^...^.^.^.^.^.^.^.^...^.......^...^.^.^...^.^.....^.^.^.^...
.............................................................................................................................................
..^.^.....^.^...^.^.^...^.^...^...^.^...^.^.^.....^.^.^.^.^.^.^.^...^.^.^.....^...^.......^...^.^.....^...^...^.....^.^.....^.^.^.^.^.^...^..
.............................................................................................................................................
.^.^.^.^...^...^.^.......^...^.^.^.......^...^.^.^...^.^...^.^...^.^.^.^.^.^.^.^.^.^.^.^.^...^...^.^.^.^.......^.^.^.^.^.....^...^.^.^.^.^.^.
.............................................................................................................................................
";

    let example_input = "
.......S.......
...............
.......^.......
...............
......^.^......
...............
.....^.^.^.....
...............
....^.^...^....
...............
...^.^...^.^...
...............
..^...^.....^..
...............
.^.^.^.^.^...^.
...............
";

    let input = example_input;

    let grid: Grid = input
        .trim()
        .lines()
        .map(|line| line.replace("S", "|").trim().chars().collect::<Vec<char>>())
        .collect();

    part_two(&grid);
}

pub fn part_two(grid: &Grid) {
    let mut cache: Cache = HashMap::new();

    let total = part_two_simulate(&mut cache, grid, 0, grid);

    println!("Total: {}", total);
}

fn get_row_pattern(grid: &Grid, row: usize) -> Vec<usize> {
    grid[row]
        .iter()
        .enumerate()
        .filter_map(|(col, &ch)| if ch == '|' { Some(col) } else { None })
        .collect()
}

pub fn part_two_simulate(
    cache: &mut Cache,
    grid: &Grid,
    row: usize,
    original_grid: &Grid,
) -> u128 {
    let row_pattern = get_row_pattern(grid, row);
    let cache_key = (row, row_pattern);

    if let Some(&result) = cache.get(&cache_key) {
        return result;
    }

    if row == grid.len() - 1 {
        return 1;
    }

    let mut grid = grid.clone();
    let mut result = 0;

    for column in 0..grid[0].len() {
        if grid[row][column] == '|' {
            if grid[row + 1][column] == '.' {
                grid[row + 1][column] = '|';

                let computed = part_two_simulate(cache, &grid, row + 1, original_grid);
                result = computed;
                break;
            } else if grid[row + 1][column] == '^' {
                let mut left_clone = grid.clone();
                left_clone[row + 1][column - 1] = '|';

                let left_total = part_two_simulate(cache, &left_clone, row + 1, original_grid);

                let mut right_clone = grid.clone();
                right_clone[row + 1][column + 1] = '|';

                let right_total = part_two_simulate(cache, &right_clone, row + 1, original_grid);

                result = left_total + right_total;
                break; 
            }
        }
    }

    let original_pattern = get_row_pattern(&grid, row);
    cache.insert((row, original_pattern), result);

    result
}

pub fn part_one(grid: &Grid) {
    let simulated_grid = part_one_simulate(grid);

    println!("total: {}", simulated_grid);
}

pub fn part_one_simulate(grid: &Grid) -> u32 {
    let mut total = 0;
    let mut grid = grid.clone();

    for row in 0..grid.len() - 1 {
        for column in 0..grid[0].len() {
            if grid[row][column] == '|' {
                if grid[row + 1][column] == '.' {
                    grid[row + 1][column] = '|';
                } else if grid[row + 1][column] == '^' {
                    total += 1;
                    grid[row + 1][column - 1] = '|';
                    grid[row + 1][column + 1] = '|';
                }
            }
        }
    }

    total
}

pub fn print_grid(grid: &Grid) {
    for row in grid {
        println!("{:?}", row);
    }
}
